
# CONT File Format

The CONT file is short for Contest. The file name is followed by three numbers starting at 000, example CONT.000 . This file is generated by the Contest Server from Team Entry files produced by players. Most of these structures are copies of the data generated from the original Team Entry file but ordered slightly differently.
The Contest file consists of five main data structures:
* Header
  * The header consists of a status byte and absolute file offsets to each of the data structures
* Player information
  * Includes User Id, team colors, and team name, player user name, and location
* Dino information
  * Includes species, Dino properties, initial map location and Dino names 
* Level information 
  * This is the normal level data structure
* Contest action data
  * This is the result of decision data simulated on the Contest Server. Includes everything from fighting moves to regular movements, neck movements, fire actions, and death as well

## Contest Header Structure
 
|Field|Size (bytes)|Position (hex)|Description
|--|--|--|--|	
|Contest Status|1|0|0x1=Not watched and first offset Won, 0x2=Not Watched and second offset Won, 0x3=Not watched and Draw.||
|Team 1 colors & strings|2|1||	
|Team 1 data|2|3||	
|Zeros|2|5||	
|Team 2 colors & strings|2|7||
|Team 2 data|2|9||
|Zeros|2|B||
|Level Data|2|D||
|Contest Data Offset|2|F|The actual contest data!!!|

## Team Information Data Structure

|Field|Size (bytes)|Description|
|--|--|--|
|Pyro User ID|4|Only include if it is equal to our Pyro User ID, otherwise it should be zeros|
|Marking and Skin Colors|C|0-99d||
|Fire Colors|6|0-99d||	
|Team Name|Zero terminated|When loading the contest menu page, Program checks Pyro User ID initially. Uses the enemy team name as the title. Later on, it checks this again, and prints the appropriate home team and enemy team names|
|Team Player Name|Zero terminated||
|Team Location|Zero terminated||

## Team Dino Data

|Field|Size (bytes)|Description|
|--|--|--|
|Num species|1||
|Species data|20h * num species||
|Total Dino’s|1||
|Queen Data|Num Dinos||
|Species leg type + straight/sprawling|Num Dino’s|	Changing the value here causes Leg changes when contest run
|Dino struct data|3 * num Dino’s|This data is in the actual contest entry as well|
|Team Dino X Pos|2 * Num Dinos||
|Team Dino Y Pos|2 * Num Dinos||
|Team Dino Rotation|2 * Num Dinos	
|Some Other Data|2 * Num Dinos||
|Dino Names|Zero Terminated, must be less than 50 chars|This logs the file offset of the Dino name and when the L key is pressed, looks up the name from the file|

## Contest Data Structure

The Contest Data is a series of Game Tick Frame Structures which encapsulate a set of Actions which were recorded from each Dino at that point-in-time. A Dino's action may or may not be included in any given Frame Structure. If too many frames with actions on the same dino are encountered in succession, they are "dropped" as an animation may still be running, causing the action data to be "out of sync" with what is happening on the screen. Manually tuned delays are included as a guideline for Contest AI. 
### Frame Structure
|Field|Size|Description|
|--|--|--|
|Number of Actions|1 byte|This is a counter of how many actions are in this structure. Does not include arguments in this number as they are consumed while the action is being handled||
|Actions|Number of Actions|This is an array of Action Structures with their arguments included as separate bytes, if required||

### Actions Structure
The Actions Structure within each Data Structure contains the following information
|Field|Size (bytes)|Description|
|--|--|--|
|Input_Byte|1|This is a single encoded byte which represents Dino_Index (0-9) and an Action (0-11). Together these select a Dino in the Contest Array and an Action to perform on that Dino||
|Arguments|Variable|Depending on the Action, there may be 0 or up to 2 arguments required||

### Encoding/Decoding Algorithm
Decoding algorithm has been reversed! It is straight forward so a simple encoding algorithm has been derived.

Dino_Index = a number between 0 and 9 relative to how many Dinos are actually included in the Contest data. Specifying a number outside of this range will not cause an error.

Action = a number between 0 and 11.

* Encoding Algorithm
  * Encoded_Byte = (Dino_Index * 12) + Action
* Decoding Algorithm
  * Dino_Index = floor(Encoded_Byte / 12)
  * Action = Encoded_Byte - (Dino_Index * 12)

### Dino Actions and Arguments
There are 12 actions available to perform on Dinos. This is a list of these actions, what they do (if known) and how many arguments (bytes) they require. There are no optional arguments, so an omitted argument will bring Contest Data reading out of alignment and cause Undefined Behavior.
|Action Code|Required Arguments|Description|Delay (frames)|Comments|
|--|--|--|--|--|
|0|2|Set Neck Angle|Directly proportional to Argument 1 (speed)|The neck angle can be set via two modes, mode 0 is for swinging or aiming the head and mode 1 is for during fighting and firing (head shake). Argument 1 is the neck speed and mode together, where the speed is directly proportional to the number of frames it will take to make the movement; lower is faster. Mode 0 corresponds to odd numbers and mode 1 corresponds to even numbers. Argument 2 is the neck angle. This is a single byte which can represent a positive or negative number. To move the head left, use a negative number. To move the head right, use a positive number. Number 0 sets the neck straight.||
|1|2|Set Tail Angle|Directly proportional to Argument 1 (speed)|The tail angle is a visual tell of how agile a dino is while making a turn; the steeper the angle, the more agile the dino can be. Argument 1 is the tail speed. Argument 2 is the tail angle. This is a single byte which can represent a positive or negative number. To move the tail left, use a negative number. To move the tail right, use a positive number. 0 sets the tail straight.||
|2|3|Move Dino|Directly proportional to Argument 1 (speed)|This command is used to move the dino one "step". The arguments set the heading and speed. To set heading to the left, use a negative number. To set the heading to the right, use a positive number. Heading 0 keeps the dino going straight in whatever direction it is pointed. This is an absolute heading, so it is best to gradually adjust the heading when making turns. The third argument sets a array variable for the dino related to movement||
|3|2|Breathe| |The Dino's abdomen expands/contracts based on the arguments to simulate breathing and show Dino Status (Rested, Tired, etc)||
|4|1|Step Left/Right| |Causes selected Dino to do fighting step side-to-side and rotate based on supplied argument||
|5|1|Step Forward/Back| |Causes selected Dino to do fighting step forward or back and rotate based on supplied argument||
|6|1|Unknown| |D8F1 when setting up dino, D8F2 when dino dies||
|7|1|Jump Left/Right|12|Causes selected Dino to do fighting jump side-to-side and rotate based on supplied argument||
|8|1|Jump Forward/Back|16|Causes selected Dino to do fighting jump forward or back and rotate based on the supplied argument||
|9|0|Locks neck movement?| |Updates the same byte array as Special Action 11-9 to 1. Associated with firing? Move neck normal sets to 0||
|10|0|Call| |The Dino does a Call/Roar||
|11|1 (see comments)|Special Actions| |This is a special action which based on the argument selects a unique action. Special action 7 requires an additional argument||

### Special Actions
|Action Code|Argument Code|Description|Comments|
|--|--|--|--|
|11|0|Die|Causes the selected Dino to die||
|11|1|Set Armor Display|Armor is almost gone ||
|11|2|Set Armor Display|Armor is low||
|11|3|Set Armor Display|Armor is low-medium||
|11|4|Set Armor Display|Armor is medium||
|11|5|Set Armor Display|Armor is thick||
|11|6|Set Armor Display|Armor is thickest||
|11|7|Eat Food|REQUIRES ADDITIONAL ARGUMENT, possibly ID number for food piece to be removed?||
|11|8|Attack/Fire|This makes the Dino Attack by using its Fire||
|11|9|Frees neck movement?|Updates the same byte array as Action 9 to 0. Associated with firing?||
|11|10|No Operation (nop) frame|This is not specifically part of the code, however if any number above 9 is provided for the Argument Code, it will be ignored and no new actions will be kicked off for the frame, and the contest will not end prematurely. This is great to use if all delays are still ongoing or no Dino is making an action for a frame.||

# Tracing Contest Execution
* Beginning of contestReadAllocate 9D4B:4CC
* Setup Contest Memory Size 9D4B:4EE
* Read contest data 9D4B:585
* Contest Memory Size final result 9D4B:5A1
* Beginning of contestReadFrame - 9D4B:5C2
* Continue reading data - 9D4B:5D2
* Read head of frame (num actions) - 9D4B:630
* Check read num actions - 9D4B:649
* num actions is 0 - 9D4B:A04
* num actions > 0 - 9D4B:657
* action value read from file - 9D4B:66E
* dino number decoded - 9D4B:68F
* action decoded - 9D4B:6BD

# File read trace
* 0823:FBC


## Contest Action Tracing
* action 0 - 9D4B:796
* action 1 - 9D4B:7D4
* action 2 - 9D4B:7EC
* action 3 - 9D4B:820
* action 4 - 9D4B:836
* action 5 - 9D4B:86C
* action 6 - 9D4B:87C
* action 7 - 9D4B:894
* action 8 - 9D4B:8CA
* action 9 - 9D4B:8FE
* action 10 - 9D4B:90A
* action 11 - 9D4B:916

## Action Tracing
* Action 0 location 1E0C:36CA
* Action 1 location 1E0C:39A2
* Action 2 location 1E0C:3B2A
  * Argument 3 memory location ds:65b8
  * start - var2 = ax = 0
* Action 3 location 1E0C:3AE0
* Action 4 location 1E0C:3DC8
* Action 5 location 1E0C:3FF2
* Action 6 location 1E0C:3D48
* Action 7 location 1E0C:3E6C
* Action 8 location 1E0C:3F24
* Action 9 memory location ds:5B5C + (dinoNum * 0x4B)
* Action 10 location 1E0C:41F6
* Actionid 11-7 location 1E0C:45FC
* Action 11-8 location 1E0C:4350

## Movement Details
* Compare arg 0 - 1E0C:3BAE
* Switch - 1E0C:3CB5
* Or di - 1E0C:3CEC
* Compare var2 (species leg type) - 1E0C:3D06
* arg3 needs to be in lock step with the actual game

Creep movement is the easiest, arg3 stays 0

Walk is next easiest, sequence of arg3:
* 0
* 4
* 5 - continues on until stopping, where arg3 is set to 0

Run is the hardest and most complicated
* 0
* 9
* A
* A
* B - full speed
* D - slow down
* D - slow down
* 5 - slow down
* 5
* 5
* 0
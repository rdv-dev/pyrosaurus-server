
# Contest File Format

The CONT file is short for Contest. The file name is followed by three numbers starting at 000, example CONT.000 . This file is generated by the Contest Server from Team Entry files produced by players. Most of these structures are copies of the data generated from the original Team Entry file but ordered slightly differently.
The Contest file consists of five main data structures:
* Header
  * The header consists of a status byte and absolute file offsets to each of the data structures
* Player information
  * Includes User Id, team colors, and team name, player user name, and location
* Dino information
  * Includes species, Dino properties, initial map location and Dino names 
* Level information 
  * This is the normal level data structure
* Contest action data
  * This is the result of decision data simulated on the Contest Server. Includes everything from fighting moves to regular movements, neck movements, fire actions, and death as well

## Contest Header Structure
 
|Field|Size (bytes)|Position (hex)|Description
|--|--|--|--|	
|Contest Status|1|0|0x1=Not watched and first offset Won, 0x2=Not Watched and second offset Won, 0x3=Not watched and Draw.||
|Team 1 colors & strings|2|1||	
|Team 1 data|2|3||	
|Zeros|2|5||	
|Team 2 colors & strings|2|7||
|Team 2 data|2|9||
|Zeros|2|B||
|Level Data|2|D||
|Contest Data Offset|2|F|The actual contest data!!!|

## Team Information Data Structure

|Field|Size (bytes)|Description|
|--|--|--|
|Pyro User ID|4|Only include if it is equal to our Pyro User ID, otherwise it should be zeros|
|Marking and Skin Colors|C|0-99d||
|Fire Colors|6|0-99d||	
|Team Name|Zero terminated|When loading the contest menu page, Program checks Pyro User ID initially. Uses the enemy team name as the title. Later on, it checks this again, and prints the appropriate home team and enemy team names|
|Team Player Name|Zero terminated||
|Team Location|Zero terminated||

## Team Dino Data

|Field|Size (bytes)|Description|
|--|--|--|
|Num species|1||
|Species data|20h * num species||
|Total Dino’s|1||
|Queen Data|Num Dinos||
|Species leg type + straight/sprawling|Num Dino’s|	Changing the value here causes Leg changes when contest run
|Dino struct data|3 * num Dino’s|This data is in the actual contest entry as well|
|Team Dino X Pos|2 * Num Dinos||
|Team Dino Y Pos|2 * Num Dinos||
|Team Dino Rotation|2 * Num Dinos	
|Some Other Data|2 * Num Dinos||
|Dino Names|Zero Terminated, must be less than 50 chars|This logs the file offset of the Dino name and when the L key is pressed, looks up the name from the file|

## Contest Data Structure

The Contest Data is a series of Game Tick Frame Structures which encapsulate a set of Actions which were recorded from each Dino at that point-in-time. A Dino's action may or may not be included in any given Frame Structure. If too many frames with actions on the same dino are encountered in succession, they are "dropped" as an animation may still be running, causing the action data to be "out of sync" with what is happening on the screen. Manually tuned delays are included as a guideline for Dino AI. 
### Game Tick Frame Structure
|Field|Size|Description|
|--|--|--|
|Number of Actions|1 byte|This is a counter of how many actions are in this structure. Does not include arguments in this number as they are consumed while the action is being handled||
|Actions|Number of Actions|This is an array of Action Structures with their arguments included as separate bytes, if required||

### Actions Structure
The Actions Structure within each Data Structure contains the following information
|Field|Size (bytes)|Description|
|--|--|--|
|Encoded Byte|1|This is a single encoded byte which represents Dino_Index (0-19) and an Action (0-11). Together these select a Dino in the Contest Dino Array and an Action to perform on that Dino||
|Arguments|Variable|Depending on the Action, there may be 0 or up to 3 arguments required||

### Encoding/Decoding Algorithm
Decoding algorithm has been reversed! It is straight forward so a simple encoding algorithm has been derived.

Dino_Index = a number between 0 and 19.
Action = a number between 0 and 11.

* Encoding Algorithm
  * Encoded_Byte = (Dino_Index * 12) + Action
* Decoding Algorithm
  * Dino_Index = floor(Encoded_Byte / 12)
  * Action = Encoded_Byte - (Dino_Index * 12)

Each team is limited to a maximum to 10 dinos, any more and this encoding/decoding algorithm would not work correctly because the encoded byte would be greater than 255.

## Dino Actions
There are 12 actions available to perform on Dinos. This is a list of these actions, what they do and how many arguments (bytes) they require. All arguments are required except where an Action expects 0 arguments. An omitted or extra argument will bring Contest Data reading out of alignment and cause Undefined Behavior.
|Action Code|# of Arguments|Description|Delay (frames)|Function Breakpoint|Contest Trace Breakpoint|
|--|--|--|--|--|--|
|0|2|Set Neck Angle| |1E0C:36CA|9D4B:796||
|1|2|Set Tail Angle|Equal to speed|1E0C:39A2|9D4B:7D4||
|2|3|Move Dino|Equal to speed|1E0C:3B2A|9D4B:7EC||
|3|2|Set Breath Rate| |1E0C:3AE0|9D4B:820||
|4|1|Step Left/Right| |1E0C:3DC8|9D4B:836||
|5|1|Step Forward/Back| |1E0C:3FF2|9D4B:86C||
|6|1|Dino Die| |1E0C:3D48|9D4B:87C||
|7|1|Jump Left/Right|12|1E0C:3E6C|9D4B:894||
|8|1|Jump Forward/Back|16|1E0C:3F24|9D4B:8CA||
|9|0|Locks neck movement?| | |9D4B:8FE||
|10|0|Call| |1E0C:41F6|9D4B:90A||
|11|Up to 2|Special Actions| | |9D4B:916||

### Special Actions
The first argument supplied with Action Code 11 (Special Actions) corresponds to which Action to perform. All Action except Action 7 do not take any additional arguments. The Argument Code/Action corresponds
|Action Code|Argument Code|# of Arguments|Description|Function Breakpoint|Contest Trace Breakpoint|
|--|--|--|--|--|--|
|11|0|0|Causes dino to die|N/A|9D4B:916||
|11|1-6|0|Set Armor Display|N/A| ||
|11|7|1|Eat Food|1E0C:45FC| ||
|11|8|0|Attack/Fire|1E0C:4350| ||
|11|9|0|Frees neck movement?|N/A| ||

### Actions Comments
#### Set Neck Angle

Directly proportional to Argument 1 (speed)|The neck angle can be set via two modes, mode 0 is for swinging or aiming the head and mode 1 is for during fighting and firing (head shake). Argument 1 is the neck speed and mode together, where the speed is directly proportional to the number of frames it will take to make the movement; lower is faster. Mode 0 corresponds to odd numbers and mode 1 corresponds to even numbers. Argument 2 is the neck angle. This is a single byte which can represent a positive or negative number. To move the head left, use a negative number. To move the head right, use a positive number. Number 0 sets the neck straight.

#### Set Tail Angle

The tail angle is a visual tell of how agile a dino is while making a turn; the steeper the angle, the more agile the dino can be. Argument 1 is the tail speed. Argument 2 is the tail angle. This is a single byte which can represent a positive or negative number. To move the tail left, use a negative number. To move the tail right, use a positive number. 0 sets the tail straight.

##### Function Argument Mapping
|Argument|Contest Argument Mapping|
|---|---|
|ax|Dino number (sent with encoded byte)||
|bx|Contest Argument 2||
|dx|Contest Argument 1||

#### Move Dino

This command is used to move the dino one "step". The arguments set the heading and speed and other information about the dino. The first argument controls the relative heading of the dino. To set heading to the left, use a negative number. To set the heading to the right, use a positive number. Heading 0 keeps the dino going straight in whatever direction it is pointed. It is best to gradually adjust the heading when making turns. The second argument communicates information about the dino. The third argument sets a array variable for the dino related to movement.

In total the base doMove function takes 5 arguments.

##### Contest Argument 1
Contest Argument 1 is the heading change to perform during the movement. This is represented as one byte and is a signed byte so the possible values are -127 to 127. In practice, however, the recommended value is much lower.
Passed via the ax register.

##### Contest Argument 2
Contest argument 2 is used for multiple purposes.

|Bit|Use|Description|
|---|---|---|
|8|Passed on the stack|Indicates whether the dino moving has no legs (0) or has any legs (1)||
|7 6 5|Passed via the dx register|Used to force stop a dino. 1 while dino is moving or about to move, 0 to stop dino||
|4 3 2 1|Passed via the bx register|Used to indicate the mode of the movement. More on this below||

##### Contest Argument 3
Contest argument 3 is used to directly feed an array which the doMove function uses at ds:65b8. 

##### Function Argument Mapping
|Argument|Contest Argument Mapping|
|---|---|
|ax|Contest Argument 1||
|bx|Contest Argument 2, OR 0xF||
|dx|Contest Argument 2, OR 0x70||
|stack argument var1|Contest Argument 2, OR (0x1 << 7)||
|ds:65b8|Contest Argument 3||

##### How it works

Creep movement speed

This is the only speed available to Snakes as they cannot move faster. Bipeds and quadrupeds can use this movement as well. This speed is unique because it is an intermittent movement.
|Action|ax|bx|dx|stack|speed|
|---|---|---|---|---|---|
Start movement|0|1|1|0|0||

Walk movement speed

Only Bipeds and Quadrupeds can use this movement speed
|Action|ax|bx|dx|stack|speed|
|---|---|---|---|---|---|
Start movement|0|A|1|0|0||
Speed up|0|A|1|0|4||
Full speed|0|A|1|0|5||
Stop movement|0|A|0|0|0||

Run movement speed

Only Bipeds and Quadrupeds can use this movement speed
|Action|ax|bx|dx|stack|speed|
|---|---|---|---|---|---|
Start movement|0|4|1|0|0||
Speed up 1|0|4|1|0|9||
Speed up 2|0|4|1|0|A||
Speed up 3|0|4|1|0|A||
Full speed|0|4|1|0|B||
Slow down 1|0|4|1|0|D||
Slow down 2?|0|4|1|0|F||
Slow down 3|0|4|1|0|5||
Stop movement|0|4|0|0|0||

  * Argument 3 memory location ds:65b8
  * Dino Number at ds:2F04
  * start - var2 = ax = 0


Movement Details
* Compare arg 0 - 1E0C:3BAE
* Switch - 1E0C:3CB5
* Or di - 1E0C:3CEC
* Compare var2 (species leg type) - 1E0C:3D06
* arg3 needs to be in lock step with the actual game


#### Set Breath Rate

The Dino's abdomen expands/contracts based on the arguments to simulate breathing and show Dino Status (Rested, Tired, etc)

##### Function Argument Mapping
|Argument|Contest Argument Mapping|
|---|---|
|ax|Dino number (sent with encoded byte)||
|bx|Contest Argument 2||
|dx|Contest Argument 1||

#### Step Left/Right

Causes selected Dino to do fighting step side-to-side and rotate based on supplied argument. Quadruped and snake dinos use this

#### Step Forward/Back

Causes selected Dino to do fighting step forward or back and rotate based on supplied argument. Quadruped and snake dinos use this

##### Function Argument Mapping
|Argument|Contest Argument Mapping|
|---|---|
|ax|Contest Argument 1||
|dx|1 (constant)||

#### Die

D8F1 when setting up dino, D8F2 when dino dies. This function is called repeatedly while other dinos alive and the game is still running

#### Jump Left/Right

Causes selected Dino to do fighting jump side-to-side and rotate based on supplied argument. Used only by biped dinos.

#### Jump Forward/Back

Causes selected Dino to do fighting jump forward or back and rotate based on the supplied argument. Used only by biped dinos.

#### Lock neck angle at current

Updates the same byte array as Special Action 11-9 to 1. Associated with firing? Move neck normal sets to 0

#### Call

The Dino does a Call/Roar

##### Function Argument Mapping
|Argument|Contest Argument Mapping|
|---|---|
|ax|Dino Number (send with encoded byte)||

### Special Actions
This is a special action which based on the argument selects a unique action. Special action 7 requires an additional argument

#### Set Armor Display (Special Actions 1-6)
Special Actions 1-6 all map to the same operation and set a value in an array. This array controls how a dino's armor displays as an indicator of the dino's heath.

|Action Code|Argument Code|# of Arguments|Description|Function Breakpoint|Contest Trace Breakpoint|
|--|--|--|--|--|--|
|11|1|0|Set Armor Display lowest|N/A| ||
|11|2|0|Set Armor Display low|N/A| ||
|11|3|0|Set Armor Display medium-low|N/A| ||
|11|4|0|Set Armor Display medium|N/A| ||
|11|5|0|Set Armor Display thick|N/A| ||
|11|6|0|Set Armor Display thickest|N/A| ||

#### Eat Food

This function is not only used to search for food but also to manage food pieces that are present? More reversing is required to fully understand what this function is doing.

ds:2C32 is an array of the number of food pieces and how much "energy" is left in the food. The food has about 93 "units" of energy, starting at 128. Once the "units" are below 35, the variable holding the max number of food items is decremented by one. 

|Argument|Contest Argument Mapping|
|---|---|
|ax|Dino Number (send with encoded byte)||
|ds:2C32|Value controlled by Contest Argument 1||

#### Fire

|Argument|Contest Argument Mapping|
|---|---|
|ax|Dino Number (send with encoded byte)||

#### 11-9
ds:5B5C + (dinoNum * 0x4B)
Updates the same byte array as Action 9 to 0. Associated with firing?



# Tracing Contest Execution
* Beginning of contestReadAllocate 9D4B:4CC
* Setup Contest Memory Size 9D4B:4EE
* Read contest data 9D4B:585
* Contest Memory Size final result 9D4B:5A1
* Beginning of contestReadFrame - 9D4B:5C2
* Continue reading data - 9D4B:5D2
* Read head of frame (num actions) - 9D4B:630
* Check read num actions - 9D4B:649
* num actions is 0 - 9D4B:A04
* num actions > 0 - 9D4B:657
* action value read from file - 9D4B:66E
* dino number decoded - 9D4B:68F
* action decoded - 9D4B:6BD

# File read trace
* 0823:FBC